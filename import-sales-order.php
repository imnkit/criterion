<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

use \Magento\Framework\App\Bootstrap;
include('app/bootstrap.php');
$bootstrap = Bootstrap::create(BP, $_SERVER);
$objectManager = $bootstrap->getObjectManager();

$storeManager = $objectManager->create('\Magento\Store\Model\StoreManagerInterface');
$websiteId = $storeManager->getStore()->getWebsiteId();


$state = $objectManager->get('\Magento\Framework\App\State');
$state->setAreaCode('frontend');

$client = new \SoapClient('https://www.criterionindustries.com.au/index.php/api/soap/?wsdl');

{		
		$arr = array(100002174,100002175,100002177,100002180,100002181,100002186,100002192,100002196,100002204,100002209,100002210,100002212,100002216,100002217,100002221,100002226,100002228,100002229,100002232,100002233,100002234,100002235,100002236,100002237,100002239,100002240,100002241,100002242,100002243,100002244,100002245,100002247,100002248,100002249,100002250,100002252,100002254,100002255,100002256,100002261,100002263,100002264,100002265,100002266,100002269,100002271,100002272,100002273,100002277,100002281,100002286,100002287,100002288,100002296,100002303,100002304,100002306,100002309,100002310,100002311,100002327,100002332,100002334,100002340,100002341,100002345,100002346,100002350,100002351,100002352,100002354,100002355,100002357,100002358,100002359,100002361,100002363,100002366,100002369,100002370,100002371,100002372,100002374,100002380,100002381,100002385,100002387,100002397,100002397,100002397,100002400,100002402,100002403,100002405,100002407,100002408,100002409,100002414,100002415,100002416,100002417,100002418,100002420,100002422,100002426,100002428,100002432,100002433,100002434,100002435,100002436,100002438,100002439,100002440,100002441,100002443,100002444,100002445,100002446,100002447,100002451,100002452,100002456,100002457,100002459,100002464,100002473,100002474,100002475,100002475,100002475,100002481,100002481,100002503,100002503,100002505,100002510,100002513,100002514,100002515,100002517,100002521,100002523,100002525,100002535,100002536,100002537,100002539,100002540,100002541,100002544,100002545,100002546,100002548,100002557,100002558,100002561,100002562,100002564,100002571,100002577,100002581,100002582,100002583,100002584,100002586,100002587,100002589,100002591,100002592,100002601,100002611,100002614,100002614,100002614,100002621,100002634,100002639,100002644,100002657,100002661,100002667,100002676,100002678,100002679,100002689,100002693,100002696,100002716,100002719,100002726,100002729,100002743,100002755,100002768,100002769,100002773,100002779,100002787,100002790,100002792,100002792,100002792,100002795,100002797,100002797,100002804,100002814,100002833,100002852,100002859,100002860,100002868,100002870,100002877,100002879,100002891,100002897,100002899,100002907,100002910,100002917,100002923,100002955,100002955,100002969,100002974,100002976,100002979,100002980,100002984,100002991,100002994,100003010,100003010,100003010,100003027,100003032,100003047,100003048,100003060,100003070,100003073,100003079,100003080,100003092,100003097,100003104,100003114,100003115,100003119,100003132,100003137,100003138,100003141,100003153,100003154,100003157,100003161,100003169,100003174,100003177,100003178,100003178,100003178,100003194,100003198,100003213,100003214,100003221,100003222,100003225,100003226,100003228,100003229,100003234,100003234,100003234,100003234,100003255,100003257,100003261,100003264,100003266,100003270,100003276,100003286,100003291,100003297,100003303,100003303,100003317,100003331,100003347,100003372,100003384,100003425,100003429,100003432,100003450,100003459,100003463,100003468,100003491,100003497,100003524,100003531,100003532,100003532,100003536,100003542,100003546,100003546,100003551,100003552,100003552,100003557,100003557,100003557,100003560,100003561,100003561,100003561,100003581,100003585,100003600,100003620,100003628,100003635,100003649,100003657,100003666,100003674,100003676,100003684,100003684,100003695,100003695,100003695,100003695,100003703,100003712,100003714,100003720,100003721,100003724,100003729,100003731,100003736,100003751,100003755,100003759,100003774,100003778,100003780,100003783,100003783,100003785,100003810,100003824,100003825,100003827,100003832,100003844,100003845,100003845,100003845,100003845,100003851,100003860,100003861,100003875,100003878,100003879,100003895,100003898,100003899,100003899,100003901,100003905,100003906,100003907,100003909,100003920,100003928,100003933,100003938,100003943,100003950,100003950,100003950,100003950,100003965,100003966,100003990,100003993,100003995,100004000,100004005,100004020,100004024,100004028,100004029,100004044,100004045,100004046,100004053,100004061,100004086,100004088,100004105,100004115,100004129,100004142,100004150,100004151,100004152,100004165,100004173,100004178,100004181,100004183,100004185,100004190,100004191,100004202,100004206,100004218,100004222,100004243,100004260,100004267,100004274,100004285,100004288,100004289,100004299,100004305,100004331,100004341,100004343,100004359,100004361,100004375,100004377,100004385,100004391,100004394,100004410,100004415,100004417,100004424,100004431,100004433,100004438,100004458,100004577,100004615,100004616,100004617,100004618,100004619,100004620,100004621,100004623,100004624,100004626,100004627,100004628,100004629,100004630,100004632,100004633,100004634,100004635,100004636,100004637,100004638,100004640,100004641,100004642,100004643,100004644,100004645,100004646,100004648,100004649,100004650,100004651,100004652,100004653,100004654,100004655,100004656,100004657,100004659,100004661,100004662,100004663,100004664,100004665,100004666,100004667,100004669,100004670,100004671,100004672,100004673,100004674,100004675,100004676,100004677,100004678,100004679,100004680,100004681,100004695,100004703,100004708,100004710,100004713,100004720,100004721,100004722,100004724,100004725,100004728,100004730,100004731,100004732,100004734,100004735,100004739,100004743,100004744,100004749,100004751,100004752,100004753,100004754,100004755,100004763,100004767,100004774,100004783,100004788,100004799,100004818,100004820,100004825,100004830,100004842,100004844,100004845,100004851,100004866,100004883,100004884,100004890,100004892,100004893,100004894,100004896,100004897,100004898,100004899,100004913,100004930,100004931,100004935,100004937,100004942,100004944,100004945,100004946,100004947,100004948,100004949,100004950,100004956,100004958,100004960,100004961,100004963,100004964,100004965,100004966,100004967,100004968,100004970,100004971,100004972,100004974,100004976,100004978,100004979,100004980,100004982,100004983,100004984,100004985,100004987,100004988,100004989,100004991,100004992,100004994,100004995,100004996,100004997,100004998,100004999,100005001,100005002,100005003,100005004,100005005,100005006,100005007,100005008,100005011,100005012,100005014,100005015,100005016,100005017,100005019,100005020,100005021,100005022,100005024,100005025,100005026,100005027,100005029,100005031,100005032,100005033,100005035,100005036,100005038,100005039,100005040,100005041,100005045,100005047,100005048,100005050,100005052,100005053,100005054,100005055,100005058,100005059,100005060,100005061,100005063,100005064,100005065,100005066,100005068,100005069,100005070,100005071,100005072,100005073,100005074,100005076,100005077,100005079,100005080,100005081,100005082,100005085,100005086,100005087,100005088,100005090,100005091,100005092,100005093,100005094,100005095,100005096,100005097,100005099,100005100,100005101,100005102,100005103,100005104,100005105,100005107,100005109,100005110,100005111,100005112,100005113,100005114,100005115,100005116,100005117,100005118,100005119,100005120,100005121,100005123,100005125,100005126,100005127,100005128,100005129,100005130,100005131,100005132,100005133,100005135,100005136,100005137,100005138,100005140,100005141,100005142,100005143,100005146,100005147,100005148,100005149,100005150,100005151,100005152,100005154,100005155,100005156,100005157,100005158,100005159,100005160,100005163,100005164,100005165,100005166,100005169,100005170,100005171,100005172,100005174,100005175,100005176,100005177,100005179,100005180,100005182,100005183,100005188,100005190,100005191,100005192,100005193,100005194,100005195,100005196,100005198,100005199,100005200,100005201,100005202,100005203,100005204,100005205,100005206,100005207,100005209,100005210,100005211,100005212,100005213,100005214,100005215,100005216,100005217,100005218,100005219,100005220,100005221,100005222,100005224,100005226,100005227,100005228,100005230,100005231,100005232,100005233,100005235,100005236,100005237,100005238,100005239);
		
		
		}
		
		$orderid = "";
		
				foreach($arr as $ar)
				{
					
					try
					{
					
					$session = $client->login('tester', '12345678');

					$rows = $client->call($session, 'sales_order.info', $ar);
					

				$customerFactory = $objectManager->create('\Magento\Customer\Model\CustomerFactory');
				$customerRepository = $objectManager->create('\Magento\Customer\Api\CustomerRepositoryInterface');

				$formkey = $objectManager->create('\Magento\Framework\Data\Form\FormKey');
				$quote = $objectManager->create('\Magento\Quote\Model\QuoteFactory');
				$quoteManagement = $objectManager->create('\Magento\Quote\Model\QuoteManagement');
				$orderService = $objectManager->create('\Magento\Sales\Model\Service\OrderService');

				$cartRepositoryInterface = $objectManager->create('\Magento\Quote\Api\CartRepositoryInterface');
				$cartManagementInterface = $objectManager->create('\Magento\Quote\Api\CartManagementInterface');
				$shippingRate = $objectManager->create('\Magento\Quote\Model\Quote\Address\Rate');

				

		   $email = $rows['customer_email'];
		   
		   $orderid = $ar;
		   $order_id = $rows['order_id'];
		   $firstname = $rows['customer_firstname'];
		   $lastname = $rows['customer_lastname'];
			
				$store=$storeManager->getStore();
				$websiteId = $storeManager->getStore()->getWebsiteId();
				$customer=$customerFactory->create();
				$customer->setWebsiteId($websiteId);
				$customer->loadByEmail($email);
				
				$customerId = $customer->getEntityId();	

				// load customet by email address
				if(!$customer->getEntityId()){
					//If not avilable then create this customer 
					$customer->setWebsiteId($websiteId)
							->setStore($store)
							->setFirstname($firstname)
							->setLastname($lastname)
							->setEmail($email) 
							->setPassword($email);
					$customer->save();
				}
			 
			 
				$cart_id = $cartManagementInterface->createEmptyCart();
				$cart = $cartRepositoryInterface->get($cart_id);
				$cart->setStore($store);
				// if you have already buyer id then you can load customer directly
				$customer= $customerRepository->getById($customer->getEntityId());
				$cart->setCurrency();
				$cart->assignCustomer($customer); //Assign quote to customer
				//add items in quote
		  
					$product = $objectManager->create('\Magento\Catalog\Model\Product');
					
					$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
					$productObject = $objectManager->get('Magento\Catalog\Model\Product');
				foreach($rows['items'] as $rows1)
				{
					$product = $productObject->loadByAttribute('sku',$rows1['sku']);
					
					$sku = $rows1['sku'];
					$quantity = $rows1['qty_ordered'];
					$price = $rows1['price'];
					
					if($product)
					{
						
						$product=$product->load($rows1['product_id']);
						$product->setPrice($price);
						$cart->addProduct(
							$product,
							intval($quantity)
						);
					} 
				}
				$bill = array();
				$ship = array();
				
				$bill['billing_address'] = array('firstname'=>$rows['billing_address']['firstname'], 'lastname'=>$rows['billing_address']['lastname'], 'street'=>$rows['billing_address']['street'], 'city'=>$rows['billing_address']['city'], 'country_id'=>$rows['billing_address']['country_id'], 'region'=>$rows['billing_address']['region'], 'postcode'=>$rows['billing_address']['postcode'], 'telephone'=>$rows['billing_address']['telephone'], 'fax'=>$rows['billing_address']['fax']);


				$ship['shipping_address'] = array('firstname'=>$rows['shipping_address']['firstname'], 'lastname'=>$rows['shipping_address']['lastname'], 'street'=>$rows['shipping_address']['street'], 'city'=>$rows['shipping_address']['city'], 'country_id'=>$rows['shipping_address']['country_id'], 'region'=>$rows['shipping_address']['region'], 'postcode'=>$rows['shipping_address']['postcode'], 'telephone'=>$rows['shipping_address']['telephone'], 'fax'=>$rows['shipping_address']['fax']);
				
				
				
				//Set Address to quote @todo add section in order data for seperate billing and handle it
				$cart->getBillingAddress()->addData($bill);
				$cart->getShippingAddress()->addData($ship);
				// Collect Rates and Set Shipping & Payment Method
				$shippingAddress = $cart->getShippingAddress();
				// $cart->getShippingAddress()->addShippingRate($rows['shipping_amount']);
				//@todo set in order data
				$shippingAddress->setCollectShippingRates(true)
					->setShippingAmount($rows['shipping_amount'])
					->setShippingMethod('flatrate_flatrate'); //shipping method
			   
				// $cart->getShippingAddress()->addShippingRate($this->shippingRate);
				
				/* $shippingAddress->setCollectShippingRates(true)
								->collectShippingRates()
								->setShippingMethod('flatrate_flatrate'); */
				
				$payMethod = $rows['payment']['method'];				
				$cart->setPaymentMethod($payMethod); //payment method
				$cart->setShippingAmount($rows['shipping_amount']); //payment method
				
				
				
				//@todo insert a variable to affect the invetory
				$cart->setInventoryProcessed(false);
				// Set sales order payment
				$cart->getPayment()->importData(['method' => $payMethod]);
				// Submit the quote and create the order
			   /*  $cart->save();
				$cart = $cartRepositoryInterface->get($cart->getId());
				$order_id = $cartManagementInterface->placeOrder($cart->getId()); */
					/* if($cart)
					{
						echo "yes3";die;
					} else {
						echo "No3";die;
					} */
					
				
					if($cart->save()){

					$cart = $cartRepositoryInterface->get($cart->getId());
					$order_id = $cartManagementInterface->placeOrder($cart->getId());

					echo "<b>$ar</b><br>";
					} else {
					echo "<b style='color:red'>$ar</b><br>";
					}
				}					
				catch(Exception $ex)
				{
					$myfile = fopen("logs.txt", "a") or die("Unable to open file!");
					$txt = $orderid." => ".$ex->getMessage();
					fwrite($myfile, "\n". $txt);
					fclose($myfile);
				}
				/* try
				{
			
				//return $order_id;
				echo 'Order id : '.$order_id.'&nbsp; Order Created Successfully';
			
				 }
					catch(Exception $ex)
					{
					echo "Error=".$ex->getMessage();
					// another way to call error_log():
				   //error_log("Error", 3, "/log/order-error.log");
				   
				   error_log($ex);

					} */
			}
					
		
			


?>